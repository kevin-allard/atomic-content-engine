<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Annotation Flow Diagram</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5f5f5;
            margin: 0;
            padding: 2rem;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1rem;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .download-button {
            display: block;
            margin: 2rem auto;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #3f51b5;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .download-button:hover {
            background-color: #303f9f;
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body>

    <h1>The Student Annotation Flow</h1>
    <div class="container">
        <svg id="annotation-flow-diagram" width="840" height="720" viewBox="0 0 840 720" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#555" />
                </marker>
            </defs>
            <style>
                .title { font-family: 'Roboto', sans-serif; font-size: 20px; font-weight: 500; fill: #3f51b5; }
                .box { fill: #ffffff; stroke: #dbe1e8; stroke-width: 1.5; rx: 4; }
                .box-text { font-family: 'Roboto', sans-serif; font-size: 13px; fill: #333; }
                .arrow { stroke: #555; stroke-width: 2; marker-end: url(#arrowhead); }
                .icon { fill: #3f51b5; }
                .label-text { font-family: 'Roboto', sans-serif; font-size: 12px; font-weight: 500; fill: #555; }
            </style>
        
            <!-- Background -->
            <rect width="100%" height="100%" fill="#f9fafb" />
        
            <!-- Column 1: SAVING -->
            <text x="190" y="40" text-anchor="middle" class="title">Saving an Annotation</text>
            <line x1="50" y1="60" x2="330" y2="60" stroke="#3f51b5" stroke-width="2"/>
        
            <!-- Step 1.1: Student Action -->
            <g transform="translate(160, 90)">
                <path class="icon" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                <text x="30" y="15" class="label-text">Student highlights text in Viewer</text>
            </g>
            <line x1="172" y1="130" x2="172" y2="150" class="arrow" />
        
            <!-- Step 1.2: JS Calculation -->
            <rect x="20" y="160" width="305" height="70" class="box" />
            <text x="172.5" y="185" text-anchor="middle" class="box-text">
                <tspan x="172.5" dy="0">Client JS finds `data-atom-id` of the</tspan>
                <tspan x="172.5" dy="1.2em">element and calculates character offset</tspan>
                <tspan x="172.5" dy="1.2em">within that specific atom.</tspan>
            </text>
            <line x1="172.5" y1="230" x2="172.5" y2="250" class="arrow" />
        
            <!-- Step 1.3: Construct JSON -->
            <rect x="20" y="260" width="305" height="100" class="box" />
            <text x="172.5" y="280" text-anchor="middle" class="box-text">
                <tspan x="172.5" dy="0">Constructs Interaction JSON Object:</tspan>
                <tspan x="172.5" dy="1.5em" style="font-family:monospace; font-size:11px;">{</tspan>
                <tspan x="172.5" dy="1.2em" style="font-family:monospace; font-size:11px;">  "startAtomId": "atom-uuid-xyz",</tspan>
                <tspan x="172.5" dy="1.2em" style="font-family:monospace; font-size:11px;">  "startOffset": 150, ...</tspan>
                <tspan x="172.5" dy="1.2em" style="font-family:monospace; font-size:11px;">}</tspan>
            </text>
            <line x1="172.5" y1="360" x2="172.5" y2="380" class="arrow" />
        
            <!-- Step 1.4: API POST -->
            <g transform="translate(100, 390)">
                <path class="icon" d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                <text x="35" y="15" class="label-text">POST to Interaction Service API</text>
            </g>
            <line x1="172.5" y1="430" x2="172.5" y2="450" class="arrow" />
        
            <!-- Step 1.5: Database -->
            <g transform="translate(130, 460)">
                 <path class="icon" d="M18 17v-6c0-3.31-2.69-6-6-6S6 7.69 6 11v6H4v4h16v-4h-2zm-6-8c2.21 0 4 1.79 4 4v6H8v-6c0-2.21 1.79-4 4-4z"/>
                <text x="30" y="15" class="label-text">Persisted in Database</text>
            </g>
            
            <!-- Separator Line -->
            <line x1="420" y1="20" x2="420" y2="700" stroke="#dbe1e8" stroke-width="1.5" />
            
            <!-- Column 2: LOADING -->
            <text x="630" y="40" text-anchor="middle" class="title">Loading an Annotation</text>
            <line x1="480" y1="60" x2="780" y2="60" stroke="#3f51b5" stroke-width="2"/>
            
            <!-- Step 2.1: Viewer Loads -->
            <g transform="translate(590, 90)">
                <path class="icon" d="M21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-1 14H4c-.55 0-1-.45-1-1V7c0-.55.45-1 1-1h16c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1z"/>
                <text x="30" y="15" class="label-text">Viewer Application Loads</text>
            </g>
            <line x1="602" y1="130" x2="602" y2="150" class="arrow" />
            
            <!-- Step 2.2: API GETs -->
             <g transform="translate(485, 160)">
                <path class="icon" d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/>
                <text x="30" y="15" class="label-text">
                    <tspan x="30" dy="0">GET Content Definition (JSON)</tspan>
                    <tspan x="30" dy="1.2em">GET User Interactions (Annotations)</tspan>
                </text>
            </g>
            <line x1="602" y1="200" x2="602" y2="220" class="arrow" />
        
            <!-- Step 2.3: Render Atoms -->
            <rect x="450" y="230" width="305" height="70" class="box" />
            <text x="602.5" y="255" text-anchor="middle" class="box-text">
                <tspan x="602.5" dy="0">Viewer filters atoms based on context</tspan>
                <tspan x="602.5" dy="1.2em">(activity, support level) and renders them</tspan>
                <tspan x="602.5" dy="1.2em">into HTML with `data-atom-id` attributes.</tspan>
            </text>
            <line x1="602.5" y1="300" x2="602.5" y2="320" class="arrow" />
        
            <!-- Step 2.4: Find Matching Elements -->
            <rect x="450" y="330" width="305" height="70" class="box" />
            <text x="602.5" y="365" text-anchor="middle" class="box-text">
                <tspan x="602.5" dy="0">For each annotation, Client JS finds</tspan>
                <tspan x="602.5" dy="1.2em">rendered elements with matching `data-atom-id`.</tspan>
            </text>
            <line x1="602.5" y1="400" x2="602.5" y2="420" class="arrow" />
            
            <!-- Step 2.5: Apply Highlight -->
            <rect x="450" y="430" width="305" height="70" class="box" />
            <text x="602.5" y="465" text-anchor="middle" class="box-text">
                <tspan x="602.5" dy="0">Reconstructs the text `Range` using</tspan>
                <tspan x="602.5" dy="1.2em">the stored character offset and wraps it.</tspan>
            </tspan>
            <line x1="602.5" y1="500" x2="602.5" y2="520" class="arrow" />
            
            <!-- Step 2.6: Final Result -->
            <g transform="translate(565, 530)">
                <path class="icon" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                <text x="30" y="15" class="label-text">Student sees their highlight</text>
            </g>
        
        </svg>
    </div>

    <button id="download-btn" class="download-button">Download SVG</button>

    <script>
        document.getElementById('download-btn').addEventListener('click', () => {
            const svg = document.getElementById('annotation-flow-diagram');
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'student-annotation-flow.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>