<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosaic: Atomic Content Editor</title>
    <style>
        :root {
            --bg-color: #f4f7fa;
            --panel-bg: #ffffff;
            --border-color: #dbe1e8;
            --primary-color: #005a9c;
            --primary-hover: #004b80;
            --text-color: #333;
            --label-color: #555;
            --accent-color: #e67e22;
            --danger-color: #c0392b;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .editor-container {
            display: grid;
            grid-template-columns: 300px 1fr 340px;
            width: 100%;
            height: 100%;
            gap: 1rem;
            padding: 1rem;
        }
        .panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        .panel-content { padding: 1rem; flex-grow: 1; }
        #canvas { padding: 2rem; }
        .atom {
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            position: relative;
            background-color: #fafafa;
        }
        .atom:hover { border-color: #c0cbe1; }
        .atom.selected { border-color: var(--primary-color); background-color: #f0f8ff; }
        .atom-placeholder {
            padding: 1.5rem;
            border-radius: 4px;
            font-weight: bold;
            color: white;
            text-align: center;
            font-size: 0.9em;
        }
        .atom-placeholder.interactive { background-color: #3498db; }
        .atom-placeholder.media { background-color: #9b59b6; }
        .atom-placeholder.learnosity { background-color: #1abc9c; }
        .atom .conditional-badge {
            position: absolute; top: 5px; right: 5px; background-color: var(--accent-color); color: white;
            font-size: 0.7rem; padding: 2px 5px; border-radius: 10px; font-weight: bold; cursor: help;
        }
        .activity-item { padding: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .add-atom-bar { text-align: center; margin: 1rem 0; }
        button, select {
            padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px;
            background-color: #fdfdfd; cursor: pointer; font-size: 0.9rem;
        }
        button.primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: 600; }
        button.primary:hover { background-color: var(--primary-hover); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; color: var(--label-color); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
        .checkbox-group label { display: flex; align-items: center; margin-bottom: 0.5rem; font-weight: normal; font-size: 0.9rem; }
        .checkbox-group input { width: auto; margin-right: 0.5rem; }
        .rule-card { background: var(--bg-color); padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; margin-top: 0.5rem; }
        .rule-card-header { display: flex; justify-content: space-between; align-items: center; }
        .rule-card-header .title { font-weight: bold; font-size: 0.9rem; }
        .rule-card-header .actions { display: flex; gap: 0.5rem; }
        .icon-btn { background: none; border: none; padding: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-radius: 4px; color: #555;}
        .icon-btn:hover { background-color: rgba(0,0,0,0.1); color: #000; }
        .icon-btn.delete:hover { color: var(--danger-color); }
        .icon-btn svg { width: 16px; height: 16px; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            z-index: 999; display: none;
        }
        .modal-container {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--panel-bg);
            z-index: 1000; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%; max-width: 500px; display: none; flex-direction: column; max-height: 80vh;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { margin: 0; color: var(--primary-color); }
        .modal-close-btn { font-size: 1.5rem; font-weight: bold; color: #aaa; cursor: pointer; background: none; border: none; }
        .modal-content { padding: 1rem; overflow-y: auto; }
        .modal-footer { padding: 1rem; border-top: 1px solid var(--border-color); text-align: right; }
        #activity-link-list { list-style-type: none; padding: 0; margin: 0; }
        #activity-link-list li { padding: 0.5rem 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="editor-container">
        <!-- Left Panel -->
        <div id="document-panel" class="panel">
            <div class="panel-header">Document Settings</div>
            <div class="panel-content">
                <div class="form-group">
                    <label for="doc-title">Title</label>
                    <input type="text" id="doc-title" value="New Document">
                </div>
                <hr>
                <h4>Linked Activities</h4>
                <div id="activity-list"></div>
                <button id="link-activity-btn">Link Activity</button>
                <hr>
                <h4>Levels of Support</h4>
                <div id="support-levels-list" class="checkbox-group"></div>
            </div>
            <div style="padding: 1rem; border-top: 1px solid var(--border-color);">
                <button id="generate-json-btn" class="primary" style="width: 100%;">Generate Document JSON</button>
            </div>
        </div>

        <!-- Center Panel -->
        <div id="canvas-panel" class="panel">
            <div id="canvas" class="panel-content"></div>
            <div class="add-atom-bar">
                <select id="add-atom-type">
                    <option value="text">Text</option>
                    <option value="interactive">Interactive</option>
                    <option value="media">Media</option>
                    <option value="learnosity">Learnosity</option>
                </select>
                <button id="add-atom-btn" class="primary">Add Content Atom</button>
            </div>
        </div>

        <!-- Right Panel -->
        <div id="properties-panel" class="panel">
            <div class="panel-header">Properties</div>
            <div id="properties-content" class="panel-content">
                <p>Select an atom to see its properties.</p>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="json-modal-overlay" class="modal-overlay"></div>
    <div id="json-modal-container" class="modal-container">
        <div class="modal-header">
            <h3>Document JSON Output</h3>
            <button class="modal-close-btn" data-modal="json">&times;</button>
        </div>
        <div class="modal-content">
            <textarea id="json-output" readonly style="height: 50vh; resize: none;"></textarea>
        </div>
    </div>

    <div id="activity-modal-overlay" class="modal-overlay"></div>
    <div id="activity-modal-container" class="modal-container">
        <div class="modal-header">
            <h3>Link Activities</h3>
            <button class="modal-close-btn" data-modal="activity">&times;</button>
        </div>
        <div class="modal-content">
            <input type="text" id="activity-search" placeholder="Search activities..." style="margin-bottom: 1rem; width: 100%;">
            <ul id="activity-link-list"></ul>
        </div>
        <div class="modal-footer">
            <button id="cancel-link-activity-btn">Cancel</button>
            <button id="save-link-activity-btn" class="primary">Save Links</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- MOCK DATABASE ---
    const mockActivityDatabase = [
        { id: generateUUID(), name: "Week 1: Introduction Quiz" },
        { id: generateUUID(), name: "Week 1: Initial Reading" },
        { id: generateUUID(), name: "Module 1: Self-Reflection" },
        { id: generateUUID(), name: "Week 2: Photosynthesis Deep Dive" },
        { id: generateUUID(), name: "Week 2: Lab Simulation" },
        { id: generateUUID(), name: "Module 2: Key Concepts Check" },
        { id: generateUUID(), name: "Final Project: Outline Submission" },
        { id: generateUUID(), name: "Midterm Review Activity" }
    ];
    const ALL_SUPPORT_LEVELS = ['light', 'moderate', 'intensive', 'light-multilingual', 'moderate-multilingual', 'intensive-multilingual'];

    // --- STATE MANAGEMENT ---
    let documentState = {
        id: generateUUID(),
        title: "New Document",
        linkedActivityIds: [],
        availableSupportLevels: [...ALL_SUPPORT_LEVELS],
        atoms: []
    };
    let selectedAtomId = null;

    // --- ICONS ---
    const ICONS = {
        edit: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`,
        save: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" /></svg>`,
        delete: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`,
    };

    // --- UTILITY FUNCTIONS ---
    function generateUUID() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
    }
    
    // --- RENDER FUNCTIONS ---
    function renderLinkedActivities() {
        const listEl = document.getElementById('activity-list');
        listEl.innerHTML = '';
        if (documentState.linkedActivityIds.length === 0) {
            listEl.innerHTML = '<p style="font-size: 0.9em; color: #777;">No activities linked yet.</p>';
            return;
        }
        const fragment = document.createDocumentFragment();
        documentState.linkedActivityIds.forEach(id => {
            const activity = mockActivityDatabase.find(a => a.id === id);
            if (activity) {
                const itemEl = document.createElement('div');
                itemEl.className = 'activity-item';
                itemEl.textContent = activity.name;
                fragment.appendChild(itemEl);
            }
        });
        listEl.appendChild(fragment);
    }
    
    function renderSupportLevels() {
        const listEl = document.getElementById('support-levels-list');
        listEl.innerHTML = '';
        ALL_SUPPORT_LEVELS.forEach(level => {
            const isChecked = documentState.availableSupportLevels.includes(level);
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" data-level="${level}" ${isChecked ? 'checked' : ''}> ${level.replace(/-/g, ' ')}`;
            listEl.appendChild(label);
        });
    }

    function renderCanvas() {
        const canvas = document.getElementById('canvas');
        canvas.innerHTML = '';
        documentState.atoms.forEach(atom => {
            const atomEl = document.createElement('div');
            atomEl.className = 'atom';
            atomEl.dataset.atomId = atom.id;
            atomEl.dataset.atomType = atom.type;
            if (atom.id === selectedAtomId) atomEl.classList.add('selected');

            let content = '';
            switch (atom.type) {
                case 'text':
                    const tag = atom.content.subtype === 'heading' ? 'h2' : 'p';
                    const textContent = atom.content.text.replace(/</g, "&lt;").replace(/>/g, "&gt;") || '<em style="color:#999;">Empty text atom...</em>';
                    content = `<${tag}>${textContent}</${tag}>`;
                    break;
                case 'interactive':
                    content = `<div class="atom-placeholder interactive">Interactive: ${atom.content.id || 'Not set'}</div>`;
                    break;
                case 'media':
                    content = `<div class="atom-placeholder media">Media: ${atom.content.src || 'Not set'}</div>`;
                    break;
                case 'learnosity':
                    content = `<div class="atom-placeholder learnosity">Learnosity Item: ${atom.content.ref || 'Not set'}</div>`;
                    break;
            }
            atomEl.innerHTML = content;
            
            if (atom.displayRules.length > 0) {
                const badge = document.createElement('span');
                badge.className = 'conditional-badge';
                badge.textContent = 'R';
                badge.title = `${atom.displayRules.length} display rule(s) applied.`;
                atomEl.appendChild(badge);
            }
            canvas.appendChild(atomEl);
        });
    }

    function renderPropertiesPanel() {
        const propertiesContent = document.getElementById('properties-content');
        if (!selectedAtomId) {
            propertiesContent.innerHTML = '<p>Select an atom to see its properties.</p>';
            return;
        }
        const atom = documentState.atoms.find(a => a.id === selectedAtomId);
        if (!atom) return;

        let contentHtml = '';
        if (atom.type === 'text') {
            contentHtml = `
                <div class="form-group">
                    <label>Subtype</label>
                    <select class="property-input" data-property="subtype" data-path="content">
                        <option value="paragraph" ${atom.content.subtype === 'paragraph' ? 'selected' : ''}>Paragraph</option>
                        <option value="heading" ${atom.content.subtype === 'heading' ? 'selected' : ''}>Heading</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Text Content</label>
                    <textarea class="property-input" data-property="text" data-path="content">${atom.content.text}</textarea>
                </div>`;
        } else {
             contentHtml = `<p>Properties for <strong>${atom.type}</strong> atoms would go here.</p>`;
        }


        const rulesHtml = atom.displayRules.map((rule, index) => {
            const linkedActivities = mockActivityDatabase.filter(a => documentState.linkedActivityIds.includes(a.id));
            
            if (rule.isEditing) {
                const activityOptions = linkedActivities.map(act => `<option value="${act.id}" ${rule.activityId === act.id ? 'selected' : ''}>${act.name}</option>`).join('');
                const supportCheckboxes = documentState.availableSupportLevels.map(level => `
                    <label><input type="checkbox" class="rule-input-checkbox" data-level="${level}" ${(rule.supportLevel || []).includes(level) ? 'checked' : ''}> ${level.replace(/-/g, ' ')}</label>
                `).join('');

                return `
                    <div class="rule-card" data-rule-index="${index}">
                        <div class="rule-card-header">
                            <span class="title">Editing Rule ${index + 1}</span>
                            <div class="actions">
                                <button class="icon-btn save-rule-btn" title="Save Rule">${ICONS.save}</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Activity</label>
                            <select class="rule-input" data-property="activityId">
                                <option value="">Any Linked Activity</option>
                                ${activityOptions}
                            </select>
                        </div>
                        <div class="form-group checkbox-group">
                            <label>Support Level(s)</label>
                            ${supportCheckboxes}
                        </div>
                    </div>
                `;
            } else {
                 const activityName = linkedActivities.find(a => a.id === rule.activityId)?.name || "Any Linked Activity";
                 const levels = rule.supportLevel.length > 0 ? rule.supportLevel.join(', ').replace(/-/g, ' ') : "All Available Levels";
                return `
                     <div class="rule-card" data-rule-index="${index}">
                        <div class="rule-card-header">
                            <span class="title">Rule ${index + 1}</span>
                             <div class="actions">
                                <button class="icon-btn edit-rule-btn" title="Edit Rule">${ICONS.edit}</button>
                                <button class="icon-btn delete-rule-btn delete" title="Delete Rule">${ICONS.delete}</button>
                            </div>
                        </div>
                        <p style="font-size:0.9em; margin: 0.5em 0; line-height: 1.5;"><strong>Activity:</strong> ${activityName}<br><strong>Support:</strong> ${levels}</p>
                    </div>
                `;
            }
        }).join('');

        propertiesContent.innerHTML = `
            <h4>Atom Properties</h4>
            <div class="form-group">
                <label>Atom ID</label>
                <input type="text" value="${atom.id}" readonly>
            </div>
            ${contentHtml}
            <hr>
            <h4>Display Rules</h4>
            <div id="rules-container">${rulesHtml}</div>
            <button id="add-rule-btn">Add Display Rule</button>
            <hr>
            <button id="delete-atom-btn" style="background-color: var(--danger-color); color: white;">Delete Atom</button>
        `;
    }

    function fullRender() {
        renderLinkedActivities();
        renderSupportLevels();
        renderCanvas();
        renderPropertiesPanel();
    }
    
    // --- EVENT HANDLERS ---
    document.getElementById('doc-title').addEventListener('change', e => documentState.title = e.target.value);
    
    document.getElementById('add-atom-btn').addEventListener('click', () => {
        const type = document.getElementById('add-atom-type').value;
        const newAtom = {
            id: generateUUID(), type: type, displayRules: []
        };
        switch(type) {
            case 'text': newAtom.content = { subtype: 'paragraph', text: '' }; break;
            default: newAtom.content = {}; break;
        }
        documentState.atoms.push(newAtom);
        selectedAtomId = newAtom.id;
        fullRender();
    });
    
    document.getElementById('canvas').addEventListener('click', (e) => {
        const atomEl = e.target.closest('.atom');
        if (atomEl) {
            selectedAtomId = atomEl.dataset.atomId;
            fullRender();
        }
    });
    
    document.getElementById('support-levels-list').addEventListener('change', e => {
        if (e.target.type === 'checkbox') {
            const level = e.target.dataset.level;
            if (e.target.checked) {
                if (!documentState.availableSupportLevels.includes(level)) documentState.availableSupportLevels.push(level);
            } else {
                documentState.availableSupportLevels = documentState.availableSupportLevels.filter(l => l !== level);
            }
            renderPropertiesPanel();
        }
    });

    const propertiesContent = document.getElementById('properties-content');
    propertiesContent.addEventListener('input', e => {
        if (e.target.classList.contains('property-input')) {
            const atom = documentState.atoms.find(a => a.id === selectedAtomId);
            if (!atom) return;
            atom[e.target.dataset.path][e.target.dataset.property] = e.target.value;
            renderCanvas();
        }
    });
    propertiesContent.addEventListener('change', e => {
        if (e.target.classList.contains('property-input') && e.target.tagName === 'SELECT') {
            const atom = documentState.atoms.find(a => a.id === selectedAtomId);
            if (!atom) return;
            atom[e.target.dataset.path][e.target.dataset.property] = e.target.value;
            renderCanvas();
        }
    });

    propertiesContent.addEventListener('click', e => {
        const button = e.target.closest('.icon-btn, button');
        if (!button) return;
        
        const atom = documentState.atoms.find(a => a.id === selectedAtomId);
        if (!atom) return;

        if (button.id === 'add-rule-btn') {
            atom.displayRules.push({ activityId: '', supportLevel: [], isEditing: true });
            fullRender();
        } else if (button.id === 'delete-atom-btn') {
            if (confirm('Are you sure you want to delete this atom?')) {
                documentState.atoms = documentState.atoms.filter(a => a.id !== selectedAtomId);
                selectedAtomId = null;
                fullRender();
            }
        } else {
            const ruleCard = button.closest('.rule-card');
            if (!ruleCard) return;
            const ruleIndex = parseInt(ruleCard.dataset.ruleIndex, 10);
            const rule = atom.displayRules[ruleIndex];

            if (button.classList.contains('edit-rule-btn')) {
                rule.isEditing = true;
                fullRender();
            } else if (button.classList.contains('save-rule-btn')) {
                rule.activityId = ruleCard.querySelector('.rule-input[data-property="activityId"]').value;
                const checkedLevels = Array.from(ruleCard.querySelectorAll('.rule-input-checkbox:checked')).map(cb => cb.dataset.level);
                rule.supportLevel = checkedLevels;
                rule.isEditing = false;
                fullRender();
            } else if (button.classList.contains('delete-rule-btn')) {
                atom.displayRules.splice(ruleIndex, 1);
                fullRender();
            }
        }
    });

    // --- MODAL LOGIC ---
    function openModal(type) { document.getElementById(`${type}-modal-overlay`).style.display = 'block'; document.getElementById(`${type}-modal-container`).style.display = 'flex'; }
    function closeModal(type) { document.getElementById(`${type}-modal-overlay`).style.display = 'none'; document.getElementById(`${type}-modal-container`).style.display = 'none'; }
    
    document.getElementById('generate-json-btn').addEventListener('click', () => {
        document.getElementById('json-output').value = JSON.stringify(documentState, null, 2);
        openModal('json');
    });

    document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.modal)));
    document.querySelectorAll('.modal-overlay').forEach(el => el.addEventListener('click', () => closeModal(el.id.split('-')[0])));

    // Activity Link Modal Logic
    const linkActivityBtn = document.getElementById('link-activity-btn');
    const activityModalList = document.getElementById('activity-link-list');
    const activitySearch = document.getElementById('activity-search');
    
    linkActivityBtn.addEventListener('click', () => {
        renderActivityLinkList();
        openModal('activity');
    });

    function renderActivityLinkList(filter = '') {
        activityModalList.innerHTML = '';
        const filteredActivities = mockActivityDatabase.filter(act => act.name.toLowerCase().includes(filter.toLowerCase()));
        
        filteredActivities.forEach(act => {
            const isChecked = documentState.linkedActivityIds.includes(act.id);
            const li = document.createElement('li');
            li.innerHTML = `<label class="checkbox-group"><input type="checkbox" value="${act.id}" ${isChecked ? 'checked' : ''}>${act.name}</label>`;
            activityModalList.appendChild(li);
        });
    }

    activitySearch.addEventListener('input', () => renderActivityLinkList(activitySearch.value));
    
    document.getElementById('save-link-activity-btn').addEventListener('click', () => {
        const checkedIds = Array.from(activityModalList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        documentState.linkedActivityIds = checkedIds;
        closeModal('activity');
        fullRender();
    });
    
    document.getElementById('cancel-link-activity-btn').addEventListener('click', () => closeModal('activity'));
    

    // --- INITIALIZATION ---
    fullRender();
});
</script>
</body>
</html>